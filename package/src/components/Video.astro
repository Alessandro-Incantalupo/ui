---
import { z } from 'astro:content'
import { macromorphic, mesomorphic } from '../utils'
import { zTag } from './Tag.astro'

export const zVideo = macromorphic(
  'video',
  zTag.extend({
    video: z.string().nullish(),
    thumbnail: z.boolean().nullish(),
  })
)

type Props = z.infer<typeof zVideo>

const { video, thumbnail } = mesomorphic('video', zVideo, Astro.props)

const youtubeId =
  (video?.includes('youtube.com') || video?.includes('youtu.be')) &&
  video.split('/').pop()?.split('?').shift()
---

{
  youtubeId && !thumbnail && (
    <iframe
      class="image video"
      src={`https://www.youtube.com/embed/${youtubeId}?controls=0&showinfo=0&rel=0&modestbranding=1&loop=1`}
      title="YouTube video player"
      allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share"
      allowfullscreen
    />
  )
}

{
  youtubeId && thumbnail && (
    <img
      src={`https://img.youtube.com/vi/${youtubeId}/0.jpg`}
      alt=""
    />
  )
}
