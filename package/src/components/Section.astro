---
import { z } from 'astro:content'
import merge from 'deepmerge'
import { getEntryByProps, morph } from '../utils'
import Cards, { macro as cards } from './Cards.astro'
import Composite, { macro as composite } from './Composite.astro'
import Image, { macro as image } from './Image.astro'
import Prose, { macro as prose } from './Prose.astro'
import Tag from './Tag.astro'

type Props = z.infer<typeof macro>

export const { macro, meso, micro } = morph('section', {
  ...composite.shape,
  image: image.shape.image,
  _image: image.shape._image,
  prose: prose.shape.prose,
  _prose: prose.shape._prose,
  cards: cards.shape.cards,
  _cards: cards.shape._cards,
  direction: z.enum(['row', 'colmn']).nullish(),
  frame: z.enum(['screen', 'panel']).nullish(),
  variant: z.enum(['solid', 'soft', 'ghost']).nullish(),
  align: z.enum(['start', 'center']).nullish(),
})

const props = meso(Astro.props)
const entry = await getEntryByProps(props as any)
const merged = merge(entry?.data, props)

const { as = 'section', direction = 'column', frame, align, ...rest } = merged
---

<Tag
  {as}
  {...rest}
  class:list={['section', direction, align, frame]}
>
  <Composite {...micro(rest)} />
  <Image {...micro(rest)} />
  <Cards {...micro(rest)} />
  <Prose {...micro(rest)} />
  <slot />
</Tag>

<style is:global>
  .section {
    display: flex;
    position: relative;
    flex-direction: column;
    gap: var(--space-6);
    background: var(--hue1);
    padding: var(--space-7) var(--gutter);
    overflow-x: hidden;

    /* &:first-child {
      margin-top: 0;
      padding-top: var(--space-5);
    } */

    &.reverse > *:first-child {
      order: 2;
    }

    &.switch:nth-child(even) > *:first-child {
      @media (min-width: 1024px) {
        order: 2;
      }
    }

    &.column {
      display: flex;
      flex-direction: column;
    }

    &.row {
      display: grid;
      align-items: center;

      @media (min-width: 1024px) {
        grid-auto-columns: 1fr;
        grid-auto-flow: column;

        .prose {
          grid-row: 2;
          grid-column: 1;
        }
      }
    }

    &.start {
      align-items: flex-start;
    }

    &.stretch {
      align-items: stretch;
    }

    &.center {
      align-items: center;
    }

    &.panel {
      margin: var(--space-6) var(--gutter);
      border-width: var(--border-width);
      border-color: var(--border-color);
      border-radius: var(--radius);
      border-radius: var(--radius-2);
      background: var(--background);
      padding: var(--space-5) var(--gutter);
      padding: 0;
    }

    &.screen {
      min-height: 100vh;
    }

    &.soft {
      border-color: var(--hue6);
      background-color: var(--hue2);
    }

    &.solid {
      border-color: var(--hue9);
      background: var(--hue9);

      * {
        color: var(--hue-fg);
      }

      .button.solid {
        border-color: var(--hue-fg);
        background: var(--hue-fg);
        color: var(--hue9);
      }

      .button.soft {
        border-color: var(--hue7);
        background: var(--hue3);
        color: var(--hue11);
      }
    }
  }
</style>
