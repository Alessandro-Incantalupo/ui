---
import type { ComponentProps } from 'astro/types'
import * as cheerio from 'cheerio'
import { unflatten } from 'flat'
import { isArray, isObject } from 'radash'
import Badge from '../base/Badge.astro'
import Button from '../base/Button.astro'
import Checkbox from '../base/Checkbox.astro'
import Icon from '../base/Icon.astro'
import Image from '../base/Image.astro'
import Input from '../base/Input.astro'
import Item from '../base/Item.astro'
import Label from '../base/Label.astro'
import Logo from '../base/Logo.astro'
import Option from '../base/Option.astro'
import Rating from '../base/Rating.astro'
import Select from '../base/Select.astro'
import Textarea from '../base/Textarea.astro'
import Video from '../base/Video.astro'
import Card from '../layout/Card.astro'
import Deck from '../layout/Deck.astro'
import Field from '../layout/Field.astro'
import Footer from '../layout/Footer.astro'
import Form from '../layout/Form.astro'
import Header from '../layout/Header.astro'
import Main from '../layout/Main.astro'
import Prose from '../layout/Prose.astro'
import Section from '../layout/Section.astro'
import Stack from '../layout/Stack.astro'
import Blockquote from '../typography/Blockquote.astro'
import Heading from '../typography/Heading.astro'
import Link from '../typography/Link.astro'
import Paragraph from '../typography/Paragraph.astro'
import Tagline from '../typography/Tagline.astro'
import DecorativeBox from './DecorativeBox.astro'
import Tag from './Tag.astro'

type Html = {
  html?: string
} & {
  [key: string]: any
}

type Child = {
  component?: keyof typeof COMPONENTS
  as?: ComponentProps<typeof Tag>['as']
} & {
  [key: string]: any
}

type Props =
  | Html
  | (Html & {
      [key: string]: Child | Props
    })

const COMPONENTS = {
  Heading,
  Paragraph,
  Tagline,
  Badge,
  Blockquote,
  DecorativeBox,
  Button,
  Card,
  Checkbox,
  Stack,
  Deck,
  Field,
  Footer,
  Form,
  Main,
  Header,
  Icon,
  Image,
  Input,
  Label,
  Link,
  Logo,
  Option,
  Prose,
  Rating,
  Section,
  Select,
  Item,
  Textarea,
  Video,
}

const { ...rest } = unflatten(Astro.props) as typeof Astro.props

const keyToComponentName = (key?: string) => {
  if (!key) return
  const part = key.split(/(?=[A-Z])/).pop() ?? key
  const correctedPart = part.charAt(0).toUpperCase() + part.slice(1)
  if (correctedPart && correctedPart in COMPONENTS)
    return correctedPart as keyof typeof COMPONENTS
  return
}
---

{
  Object.entries(rest).map(([key, value]) => {
    if (key === 'text') return value
    if (key === 'html') {
      if (!value) return null
      const $ = cheerio.load(value, null, false)
      $('h1,h2,h3,h4,h5,h6').addClass('full-heading')
      $('p').addClass('full-paragraph')
      const html = $.html()
      return <Fragment set:html={html} />
    }

    if (isArray(value)) {
      const object = value.reduce((acc, v, i) => ({ ...acc, [i]: v }), {})
      return <Astro.self {...object} />
    }

    if (value.component && value.component in COMPONENTS) {
      const component = value.component as keyof typeof COMPONENTS
      const Component = component && COMPONENTS[component]
      return <Component {...value} />
    }

    if (keyToComponentName(key)) {
      const component = keyToComponentName(key) as keyof typeof COMPONENTS
      const Component = component && COMPONENTS[component]
      return <Component {...value} />
    }

    if (value.as)
      return (
        <Tag {...value}>
          <Astro.self {...value} />
        </Tag>
      )

    if (isObject(value)) return <Astro.self {...value} />

    return null
  })
}

<style></style>
