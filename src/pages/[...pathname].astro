---
import { getCollection, type ContentCollectionKey } from 'astro:content'
import merge from 'deepmerge'
import Layout from '../components/layout/Layout.astro'
import { getCollectionDefault, getPathname } from '../utils'

export async function getStaticPaths() {
  const collections: ContentCollectionKey[] = [
    'pages',
    'services',
    'posts',
    'products',
    'categories',
    'forms',
    'policies',
    'persons',
  ]

  const promises = collections.map((collection) => getCollection(collection))
  const resolved = await Promise.all(promises)
  const flattened = resolved.flat()
  const filtered = flattened.filter(Boolean)
  const entries = filtered

  return entries.map((entry) => ({
    params: {
      pathname: getPathname(entry) === '/' ? undefined : getPathname(entry),
    },
    props: entry,
  }))
}

const { ...entry } = Astro.props

const _entryData = await getCollectionDefault(entry.collection)
const mergedData = merge(_entryData, entry.data)

const mergedEntry = {
  ...entry,
  data: mergedData as typeof entry.data,
}
---

<Layout {...mergedEntry} />
