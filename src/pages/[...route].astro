---
import { getCollection, type ContentCollectionKey } from 'astro:content'
import {
  CategoryLayout,
  FormLayout,
  PageLayout,
  PersonLayout,
  PolicyLayout,
  PostLayout,
  ProductLayout,
  ServiceLayout,
  getRouteByEntry,
} from 'src'

// Function to generate static paths for all entries in all collections
export async function getStaticPaths() {
  // Object containing all collections keys
  const collections: ContentCollectionKey[] = [
    'pages',
    'services',
    'posts',
    'products',
    'categories',
    'forms',
    'policies',
    'persons',
  ]
  // Get all entries from all collections, resolve promises, flatten array, and filter out any undefined values
  const promises = collections.map((collection) => getCollection(collection))
  const results = await Promise.all(promises)
  const flattened = results.flat()
  const filtered = flattened.filter(Boolean)
  const entries = filtered

  // Return paths for all entries
  return entries.map((entry) => ({
    params: {
      route:
        getRouteByEntry(entry) === '/' ? undefined : getRouteByEntry(entry),
    },
    props: {
      entry: entry,
    },
  }))
}

// Object containing all layouts for each collection
const layouts: {
  [key in ContentCollectionKey]?: any
} = {
  pages: PageLayout,
  policies: PolicyLayout,
  categories: CategoryLayout,
  products: ProductLayout,
  posts: PostLayout,
  services: ServiceLayout,
  forms: FormLayout,
  persons: PersonLayout,
  // reviews: ReviewLayout,
}

// Get current entry from props
const { entry } = Astro.props
// Get layout for current entry
const CollectionLayout = layouts[entry.collection]
if (!CollectionLayout)
  throw new Error(`No layout found for collection: ${entry.collection}`)
---

<CollectionLayout entry={entry} />
