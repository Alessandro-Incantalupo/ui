---
import { getCollection, type ContentCollectionKey } from 'astro:content'
import {
  CategoriesLayout,
  FormsLayout,
  PagesLayout,
  PoliciesLayout,
  PostsLayout,
  ProductsLayout,
  ServicesLayout,
  getRouteByEntry,
} from 'src'

// Function to generate static paths for all entries in all collections
export async function getStaticPaths() {
  // Object containing all collections keys
  const collections: ContentCollectionKey[] = [
    'pages',
    'services',
    'posts',
    'products',
    'categories',
    'forms',
    'policies',
  ]
  // Get all entries from all collections, resolve promises, flatten array, and filter out any undefined values
  const promises = collections.map((key) => getCollection(key))
  const results = await Promise.all(promises)
  const flattened = results.flat()
  const filtered = flattened.filter(Boolean)
  const entries = filtered

  // Return paths for all entries
  return entries.map((entry) => ({
    params: {
      route:
        getRouteByEntry(entry) === '/' ? undefined : getRouteByEntry(entry),
    },
    props: {
      entry: entry,
    },
  }))
}

// Object containing all layouts for each collection
const layouts: {
  [key in ContentCollectionKey]?: any
} = {
  pages: PagesLayout,
  policies: PoliciesLayout,
  categories: CategoriesLayout,
  products: ProductsLayout,
  posts: PostsLayout,
  services: ServicesLayout,
  forms: FormsLayout,
  // reviews: ReviewsLayout,
}

// Get current entry from props
const { entry } = Astro.props
// Get layout for current entry
const CollectionLayout = layouts[entry.collection]
if (!CollectionLayout)
  throw new Error(`No layout found for collection: ${entry.collection}`)
---

<CollectionLayout entry={entry} />
