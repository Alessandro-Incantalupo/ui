---
import { getCollection, getEntry } from 'astro:content'
import Button from 'fulldev-ui/components/Button.astro'
import Spread from './Spread.astro'

const { currentSlug } = Astro.props

const sidebarEntry = await getEntry('settings', 'components')
const sidebar = sidebarEntry.data.sidebar || []

const flattenedPages = (
  await Promise.all(
    sidebar.map(async (item: any) => {
      const links = item.links || []
      if (item.folder) {
        const pages = await getCollection(
          'pages',
          (entry: any) =>
            entry.slug.startsWith(item.folder) &&
            !entry.slug.endsWith(item.folder)
        )
        links.push(
          ...pages.map((page: any) => ({
            href: `/${page.slug}`,
            title: page.data.title,
          }))
        )
      }
      return links
    })
  )
).flat()

const currentIndex = flattenedPages.findIndex(
  (page: any) => page.href === `/${currentSlug}`
)

const prevPage = flattenedPages[currentIndex - 1] || null
const nextPage = flattenedPages[currentIndex + 1] || null
---

<Spread>
  <Button
    href={prevPage?.href}
    variant="secondary"
    text={prevPage?.title + '←'}
  />
  <Button
    href={nextPage?.href}
    variant="secondary"
    text={nextPage?.title + '→'}
    class="ml-auto"
  />
</Spread>
