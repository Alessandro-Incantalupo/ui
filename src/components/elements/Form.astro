---
import type { HTMLAttributes } from 'astro/types'
import { getEntry } from 'astro:content'
import Input, { type InputProps } from '../elements/input/Input.astro'
import Select, { type SelectProps } from '../elements/select/Select.astro'
import Textarea, {
  type TextareaProps,
} from '../elements/textarea/Textarea.astro'
import type { ButtonProps } from './button/Button.astro'
import Checkbox, { type CheckboxProps } from './checkbox/Checkbox.astro'

export type FormProps = Props
interface Props {
  form?: string | null
  title?: HTMLAttributes<'input'>['value'] | null
  key?: HTMLAttributes<'input'>['value'] | null
  inputs?: (InputProps | SelectProps | CheckboxProps | TextareaProps)[] | null
  button?: ButtonProps | null
}

const components: any = {
  input: Input,
  textarea: Textarea,
  select: Select,
  checkbox: Checkbox,
}

let {
  form,
  title,
  key,
  inputs,
  button = {
    label: 'Verstuur',
    href: '/bericht-ontvangen',
  },
} = Astro.props

const formName = form?.split('/').pop()?.replace('.md', '') || 'myplaceholder'
const formEntry = await getEntry('forms', formName)
const formData = formEntry ? formEntry.data : Astro.props

const inboxKey = import.meta.env?.PUBLIC_APP_URL?.replace('https://', '')
  ?.replace('http://', '')
  ?.split('.')
  ?.shift()
---

{
  formData.inputs && (
    <form
      method="POST"
      action={formData.button.href}
    >
      {formData.inputs?.map((input: any) => {
        const key = input._bookshop_name.split('/').pop()
        const Component = components[key]
        return <Component {...input} />
      })}
      <slot />
      <input
        type="hidden"
        name="_subject"
        value={title}
      />
      <input
        type="hidden"
        name="inbox_key"
        value={inboxKey}
      />
      <input
        type="text"
        name="_gotcha"
        style="display: none;"
      />
      <button type="submit">{formData.button.label}</button>
    </form>
  )
}

<style lang="postcss">
  form {
    gap: var(--flow2);
    display: flex;
    width: 100%;
    max-width: 36rem;
    flex-direction: column;
    text-align: left;
    /* @apply gap-flow2 flex w-full max-w-xl flex-col text-left; */

    button {
      margin-top: var(--flow2);
      /* @apply button-primary hue-brand mt-flow2; */
    }
  }
</style>
