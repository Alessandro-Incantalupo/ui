---
import type { ComponentProps } from 'astro/types'
import {
  getEntry,
  type CollectionEntry,
  type ContentCollectionKey,
} from 'astro:content'
import { SectionRoot } from '.'
import { getCollectionDefault } from '../../utils'
import { Cards } from '../cards'
import { Composite } from '../composite'
import { Gallery } from '../gallery'
import { Image } from '../image'
import { Media } from '../media'
import { Prose } from '../prose'
import { Rating } from '../rating'

interface Props
  extends ComponentProps<typeof SectionRoot>,
    ComponentProps<typeof Composite>,
    ComponentProps<typeof Gallery>,
    ComponentProps<typeof Rating>,
    ComponentProps<typeof Prose>,
    ComponentProps<typeof Media> {
  _cards?: ComponentProps<typeof Cards>
  cards?: ComponentProps<typeof Cards>['cards']
  image?: ComponentProps<typeof Image>
  reference?: {
    collection: ContentCollectionKey
    slug: CollectionEntry<ContentCollectionKey>['slug']
  }
  collection?: ContentCollectionKey
  slug?: CollectionEntry<ContentCollectionKey>['slug']
  // TODO:
  render?: any
}

let {
  collection,
  slug,
  reference,
  class: className,
  render,
  ...props
} = Astro.props

collection = collection || reference?.collection
slug = slug || reference?.slug
const entry = collection && slug && (await getEntry(collection, slug))
const _data = entry && (await getCollectionDefault(entry.collection, Astro))
const mergedEntry = {
  ...entry,
  data: {
    ..._data,
    ...entry?.data,
  },
}
props = { ...mergedEntry?.data, ...props }
---

<SectionRoot
  class={className}
  {...props}
>
  <Composite
    {...props}
    align={props.layout === 'split' ? 'start' : props.align}
  />
  <Image {...props.image} />
  <Prose render={render || entry?.render} />
  <Cards
    {...props._cards}
    cards={props.cards}
  />
  <slot />
</SectionRoot>
