---
import type { ComponentProps } from 'astro/types'
import {
  getEntry,
  type CollectionEntry,
  type ContentCollectionKey,
} from 'astro:content'
import { getPathname, withDefaults } from '../../utils'
import { Composite } from '../composite'
import { Image } from '../image'
import CardRoot from './CardRoot.astro'

interface Props
  extends ComponentProps<typeof CardRoot>,
    ComponentProps<typeof Composite> {
  reference?: {
    collection: ContentCollectionKey
    slug: CollectionEntry<ContentCollectionKey>['slug']
  }
  collection?: ContentCollectionKey
  slug?: CollectionEntry<ContentCollectionKey>['slug']
  image?: ComponentProps<typeof Image>
}

let { collection, slug, reference, ...restProps } = Astro.props
reference = collection && slug && { collection, slug }
let entry = reference && (await getEntry(reference))
const entryWithDefaults = entry && (await withDefaults(entry))
const props = { ...entryWithDefaults?.data, ...restProps }
const href = getPathname(props || ({} as any))
---

<CardRoot
  {href}
  {...props}
>
  <Image
    {...props}
    {...props.images?.[0]}
    {...props.image}
  />
  <slot />
  <Composite
    {...props}
    density="compact"
  />
</CardRoot>
